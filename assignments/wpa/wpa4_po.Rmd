---
title: "WPA 4: Spring 2017"
output: html_document
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE)
```


```{r, echo = FALSE, eval = TRUE}
setwd(rprojroot::is_rstudio_project$find_file())
```


```{r echo = FALSE, eval = FALSE}



# Create demographic data
matthews.df <- read.table(file = "http://journal.sjdm.org/15/15909/data1.csv", 
                     sep = ",",
                     header = TRUE)

# Create demo.df
set.seed(100)
demo.df <- data.frame(id = matthews.df$id)
demo.df$height <- round(rnorm(n = nrow(demo.df), mean = 170, sd = 10), 0)
demo.df$race <- sample(c("white", "hispanic", "black", "asian"), size = nrow(demo.df), prob = c(.5, .1, .2, .2), replace = TRUE)

demo.df <- demo.df[sample(nrow(demo.df)),]
rownames(demo.df) <- 1:nrow(demo.df)

write.table(x = demo.df, file = "/Users/nphillips/Dropbox/Public/matthews_demographics.txt", sep = "\t")
```


## Why do we overestimate others' willingness to pay?

<img src="https://dl.dropboxusercontent.com/u/7618380/matthewsscreen.png" height="200" />

In this WPA, we will analyze data from Matthews et al. (2016): Why do we overestimate others' willingness to pay? The purpose of this research was to test if our beliefs about other people's affluence (i.e.; wealth) affect how much we think they will be willing to pay for items. You can find the full paper at http://journal.sjdm.org/15/15909/jdm15909.pdf.

### Study 1

In this WPA, we will analyze data from their first study. In study 1, participants indicated the proportion of other people taking part in the survey who have more than themselves, and then whether other people would be willing to pay more than them for each of 10 items.

The following table shows a table of the 10 projects and proportion of participants who indicated that others would be more willing to pay for the product than themselves (Table 1 in Matthews et al., 2016).


Product Number| Product | Reported p(other > self)
------------  | ------- | --------
1             | A freshly-squeezed glass of apple juice | .695
2             | A Parker ballpoint pen | .863
3             | A pair of Bose noise-cancelling headphones | .705
4             | A voucher giving dinner for two at Applebee's | .853
5             | A 16 oz jar of Planters dry-roasted peanuts | .774
6             | A one-month movie pass | .800
7             | An Ikea desk lamp | .863
8             | A Casio digital watch | .900
9             | A large, ripe pineapple| .674
10             | A handmade wooden chess set | .732

*Table 1*: Proportion of participants who indicated that the “typical participant” would pay more than they would for each product in Study 1.


**Study 1 variable description**

Here are descriptions of the data variables (taken from the author's dataset notes available at http://journal.sjdm.org/15/15909/Notes.txt)

- `id`: participant id code
- `gender`: participant gender. 1 = male, 2 = female
- `age`: participant age
- `income`: participant annual household income on categorical scale with 8 categorical options: Less than $15,000; $15,001–$25,000; $25,001–$35,000; $35,001–$50,000; $50,001–$75,000; $75,001–$100,000; $100,001–$150,000; greater than $150,000.
- `p1-p10`: whether the "typical" survey respondent would pay more (coded 1) or less (coded 0) than oneself, for each of the 10 products 
- `task`: whether the participant had to judge the proportion of other people who "have more money than you do" (coded 1) or the proportion who "have less money than you do" (coded 0)
- `havemore`: participant's response when task = 1
- `haveless`: participant's response when task = 0
- `pcmore`: participant's estimate of the proportion of people who have more than they do (calculated as 100-haveless when task=0)


1. Open RStudio. Create a new project in a new working directory on your computer. Call the project `rcourse`. In the directory of the folder, create two folders: `R`, and `data`. Your file structure should look like this:

```{r, eval = TRUE, fig.align = 'center'}
knitr::include_graphics(path = "../images/projectss.png")
```


2. Open a new R script and save it as `wpa3.R` in the `R` folder you just created

3. The data for this WPA are stored at http://journal.sjdm.org/15/15909/data1.csv. Load the data into R by using `read.table()` into a new object called `matthews.df`.

```{r, echo = TRUE, eval = T}
matthews.df <- read.table(file = "http://journal.sjdm.org/15/15909/data1.csv",  # Link to the file
                          sep = ",",                                            # File is comma-separated
                          header = TRUE,                                        # There IS a header column
                          stringsAsFactors = FALSE)                             # Do NOT convert strings to factors
```

4. Using `write.table()`, save the data as a tab--delimited text file called `matthews.txt` in the data folder as follows:

```{r, eval = FALSE, echo = TRUE, eval = FALSE}
write.table(x = matthews.df,                 # Save the object matthews.df
            file = "data/study1.txt",        # Write the object to study1.txt in the data folder
            sep = "\t")                      # Separate columns by tabs
```


5. Look at the first few rows of `matthews.df` using `head()`, and `str()` to make sure the data were loaded correctly into R

```{r, echo = FALSE}
head(matthews.df)
str(matthews.df)
```

6. What are the names of the data columns?

```{r}
names(matthews.df)
```

7. Currently gender is coded as 1 and 2. Let's create a new character column called `gender.a` that codes the data as `male` and `female`. Do this by running the following code:

```{r echo = FALSE}
# Create a new column called gender.a that codes gender as a string
matthews.df$gender.a <- NA
matthews.df$gender.a[matthews.df$gender == 1] <- "male"
matthews.df$gender.a[matthews.df$gender == 2] <- "female"
```

8. What percent of participants were male?

```{r}
mean(matthews.df$gender.a == "male")
```

9. What was the mean age?

```{r}
mean(matthews.df$age)
```

10. Using either basic indexing or `subset()`, calculate the mean age for males only.

```{r}
mean(matthews.df$age[matthews.df$gender.a == "male"])

# OR

male.df <- subset(matthews.df, subset = gender.a == "male")
mean(male.df$age)
```

11. Using either basic indexing or `subset()`, calculate the mean age for females only.

```{r}
mean(matthews.df$age[matthews.df$gender.a == "female"])

# OR

female.df <- subset(matthews.df, subset = gender.a == "female")
mean(female.df$age)
```

12. Using `aggregate()` calculate the mean age of male and female participants separately. Do you get the same answers as before?

```{r, echo = FALSE, eval = FALSE}
aggregate(formula = age ~ gender.a,
          FUN = mean,
          data = matthews.df)

# Yes the answers are the same!
```


13. The variable `pcmore` reflects the question: "What percent of people taking part in this survey do you think earn more than you do?". Using `aggregate()`, calculate the median value of this variable separately for each level of income. What does the result tell you?

```{r, echo = FALSE, eval = FALSE}
aggregate(formula = pcmore ~ income,
          FUN = median,
          data = matthews.df)

# The higher one's income, the less people think that other people make more than them.
```


14 What was the mean value of `havemore` for each combination of gender and race? (hint: Use `aggregate()` with two independent variables


#### Checkpoint! If you got this far you're doing just fine!

15. I created a new table containing fictional demographic information about each participant. The data are stored in a tab--delimited text file (with a header row) at http://nathanieldphillips.com/wp-content/uploads/2016/10/matthews_demographics.txt. Load the data into an object called  `demo.df` into R.

```{r, echo = TRUE}
demo.df <- read.table("http://nathanieldphillips.com/wp-content/uploads/2016/10/matthews_demographics.txt", 
                      sep = "\t",
                      header = TRUE)
```

16. Using `merge` add the demographic data to `matthews.df`

```{r, echo = TRUE}
matthews.df <- merge(x = matthews.df,
                     y = demo.df,
                     by = "id")
```



17. Create a new dataframe called `product.df` that only contain columns p1, p2, ... p10 from `matthews.df` by running the following code. 

```{r, echo = TRUE}
# Create product.df, a dataframe containing only columns p1, p2, ... p10
product.df <- matthews.df[,paste("p", 1:10, sep = "")]
```

18. The `colMeans()` function takes a dataframe as an argument, and returns a vector showing means across rows for each column of data. Using `colMeans()`, calculate the percentage of participants who indicated that the 'typical' participant would be willing to pay more than them for each item. Do your values match what the authors reported in Table 1?

```{r, echo = FALSE, eval = FALSE}
colMeans(product.df)

# Yes the numbers match!!!
```

19. The `rowMeans()` function is like `colMeans()`, but for calculating means across columns for every row of data. Using `rowMeans()` calculate for each participant, the percentage of the 10 items that the participant believed other people would spend more on. Save this data as a vector called `pall`.

```{r, echo = FALSE}
pall <- rowMeans(product.df)
```

20. Add the `pall` vector as a new column called `pall` to the `matthews.df` dataframe

```{r, echo = FALSE}
matthews.df$pall <- pall
```

21. What was the mean value of `pall` across participants? This value is the answer to the question: "How often does the average participant think that someone else would pay more for an item than themselves?"

```{r}
mean(matthews.df$pall)
```


22. Using `aggregate()` calculate the mean `pall` value for male and female participants separately. Which gender tends to think that others would pay more for products than them?

```{r, echo = FALSE, eval = FALSE}
aggregate(formula = pall ~ gender.a,
          FUN = mean,
          data = matthews.df)

# Males tend to think that others will pay more for items than them relative to females.
```

23.  Using `aggregate()` calculate the mean `pall` value of participants for each level of income. Do you find a consistent relationship between `pall` and income?

```{r, echo = FALSE, eval = FALSE}
aggregate(formula = pall ~ income,
          FUN = mean,
          data = matthews.df)

# The values decrease from income = 1 to income = 6, then they go up again!
```

24. For the remaining problems, we'll be using `dplyr`. Load the `dplyr` library:

```{r, echo = FALSE, message = F}
library(dplyr)
```


25. Using `dplyr`, for each level of gender, calculate the summary statistics in the following table. Save the summary statistics to an object called `gender.df`

```{r eval = FALSE, echo = FALSE}
knitr::kable(data.frame(
  variable = c("n", "age.mean", "age.sd", "income.mean", "pcmore.mean", "pall.mean"),
  description = c("Number of participants", "Mean age", "Standard deviation of age", "Mean income", "Mean value of pcmore", "Mean value of pall")
))
```


```{r, echo = FALSE, eval = FALSE}
gender.df <- matthews.df %>%
  group_by(gender) %>%
  summarise(
    n = n(),
    age.mean = mean(age),
    age.sd = sd(age),
    income.mean = mean(income),
    pcmore.mean = mean(pcmore),
    pall.mean = mean(pall)
  )

gender.df
```

26. Using `dplyr`, for each level of `income`, calculate the summary statistics in the following table -- *only for participants older than 21* -- and save them to a new object called `income.df`.

```{r eval = FALSE, echo = FALSE}
knitr::kable(data.frame(
  variable = c("n", "age.min", "age.mean", "male.p", "female.p", "pcmore.mean", "pall.mean"),
  description = c("Number of participants", "Minimum age", "Mean age", "Percent of males", "Percent of females","Mean value of pcmore", "Mean value of pall")
))
```


```{r, echo = FALSE, eval = FALSE}
income.df <- matthews.df %>%
  filter(age > 21) %>%
  group_by(income) %>%
  summarise(
    n = n(),
    age.mean = mean(age),
    male.p = mean(gender == 1),
    female.p = mean(gender == 2),
    pcmore.mean = mean(pcmore),
    pall.mean = mean(pall)
  )

income.df
```

27. Using `dplyr`, calculate several summary statistics (you choose which ones!) aggregated at each level of race and gender. Save the results to an object called `racegender.df`

```{r}
racegender.df <- matthews.df %>%
  group_by(race, gender.a) %>%
  summarise(
    n = n(),  # N
    age.max = max(age), # Oldest person
    income.mean = mean(income) # Mean income
  )

racegender.df
```


28. Using `dplyr`, calculate several summary statistics (you choose which ones!) aggregated at each level of independent variables of your choice. Save the results to an object called `XXX.df`, where XXX are the names of the variables you aggregated.

```{r}
taskgender.df <- matthews.df %>%
  group_by(task, gender.a) %>%
  summarise(
    n = n(),  # N
    pcmore.mean = mean(pcmore), # mean pcmore
    p.black = mean(race == "black") # Percent black
  )

taskgender.df
```


29. Using `save()`, save `matthews.df`, `gender.df`, `income.df`, `racegender.df`, and `XXX.df` objects to a file called `matthews.RData` in the `data` folder in your working directory.


```{r eval = FALSE}
save(matthews.df, gender.df, income.df, racegender.df, taskgender.df, file = "data/matthews.RData")
```

## Submit!

Save and email your `wpa_4_LastFirst.R` file to me at nathaniel.phillips@unibas.ch. Then, go to [https://goo.gl/forms/8pKm39PMS29JoLjI2](https://goo.gl/forms/8pKm39PMS29JoLjI2) to complete the WPA submission form.
