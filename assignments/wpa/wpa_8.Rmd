---
title: "WPA #8  -- Regression"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE, fig.align = 'center', out.width = "70%")

student.math <- read.table("http://nathanieldphillips.com/wp-content/uploads/2016/11/studentmath.txt",
                      sep = "\t",
                      header = TRUE)

student.por <- read.table("http://nathanieldphillips.com/wp-content/uploads/2016/11/studentpor.txt",
                      sep = "\t",
                      header = TRUE)
```



## Readings

This assignment is based on the following readings:

- YaRrr: [15](https://bookdown.org/ndphillips/YaRrr/regression.html)

## Assignment Goals

- Create regression objects (`lm` and `glm`) with the `lm()` and `glm()` functions
- Understand the contents of regression objects and interpret outputs.
- Use the `predict()`, `names()` and `summary()` functions to access specific elements of regression objects.
- Create APA tables from regression objects with `

## Examples

```{r, echo = TRUE, eval = FALSE}

```




## Student Performance

<img src="http://www.funnfun.in/wp-content/uploads/2013/03/love-for-study-funny-student-450x329.jpg" style="height:400px;" />


In this WPA, you will analyze data from a study on student performance in two classes: math and Portuguese. These data come from the UCI Machine Learning database at http://archive.ics.uci.edu/ml/datasets/Student+Performance#

Here is the data description (taken directly from the original website

*This data approach student achievement in secondary education of two Portuguese schools. The data attributes include student grades, demographic, social and school related features) and it was collected by using school reports and questionnaires. Two datasets are provided regarding the performance in two distinct subjects: Mathematics (mat) and Portuguese language (por). In [Cortez and Silva, 2008], the two datasets were modeled under binary/five-level classification and regression tasks. Important note: the target attribute G3 has a strong correlation with attributes G2 and G1. This occurs because G3 is the final year grade (issued at the 3rd period), while G1 and G2 correspond to the 1st and 2nd period grades. It is more difficult to predict G3 without G2 and G1, but such prediction is much more useful (see paper source for more details).*

The data are located in two tab-delimited text files at http://nathanieldphillips.com/wp-content/uploads/2016/11/studentmath.txt (the math data), and http://nathanieldphillips.com/wp-content/uploads/2016/11/studentpor.txt (the portugese data).


## Datafile description

Both datafiles have 33 columns. Here they are:

1 school - student's school (binary: 'GP' - Gabriel Pereira or 'MS' - Mousinho da Silveira) 

2 sex - student's sex (binary: 'F' - female or 'M' - male) 

3 age - student's age (numeric: from 15 to 22) 

4 address - student's home address type (binary: 'U' - urban or 'R' - rural) 

5 famsize - family size (binary: 'LE3' - less or equal to 3 or 'GT3' - greater than 3) 

6 Pstatus - parent's cohabitation status (binary: 'T' - living together or 'A' - apart) 

7 Medu - mother's education (numeric: 0 - none, 1 - primary education (4th grade), 2 â€“ 5th to 9th grade, 3 â€“ secondary education or 4 â€“ higher education) 

8 Fedu - father's education (numeric: 0 - none, 1 - primary education (4th grade), 2 - 5th to 9th grade, 3 - secondary education or 4 - higher education) 

9 Mjob - mother's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other') 

10 Fjob - father's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other') 

11 reason - reason to choose this school (nominal: close to 'home', school 'reputation', 'course' preference or 'other') 

12 guardian - student's guardian (nominal: 'mother', 'father' or 'other') 

13 traveltime - home to school travel time (numeric: 1 - <15 min., 2 - 15 to 30 min., 3 - 30 min. to 1 hour, or 4 - >1 hour) 

14 studytime - weekly study time (numeric: 1 - <2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours) 

15 failures - number of past class failures (numeric: n if 1<=n<3, else 4) 

16 schoolsup - extra educational support (binary: yes or no) 

17 famsup - family educational support (binary: yes or no) 

18 paid - extra paid classes within the course subject (Math or Portuguese) (binary: yes or no) 

19 activities - extra-curricular activities (binary: yes or no) 

20 nursery - attended nursery school (binary: yes or no) 

21 higher - wants to take higher education (binary: yes or no) 

22 internet - Internet access at home (binary: yes or no) 

23 romantic - with a romantic relationship (binary: yes or no) 

24 famrel - quality of family relationships (numeric: from 1 - very bad to 5 - excellent) 

25 freetime - free time after school (numeric: from 1 - very low to 5 - very high) 

26 goout - going out with friends (numeric: from 1 - very low to 5 - very high) 

27 Dalc - workday alcohol consumption (numeric: from 1 - very low to 5 - very high) 

28 Walc - weekend alcohol consumption (numeric: from 1 - very low to 5 - very high) 

29 health - current health status (numeric: from 1 - very bad to 5 - very good) 

30 absences - number of school absences (numeric: from 0 to 93) 

31 G1 - first period grade (numeric: from 0 to 20) 

31 G2 - second period grade (numeric: from 0 to 20) 

32 G3 - final grade (numeric: from 0 to 20, output target)


## Data loading and preparation

1. <font color = "red">Open your class R project</font>. This project should have (at least) two folders, one called `data` and one called `R`. Open a new script and enter your name, date, and the wpa number at the top. Save the script in the `R` folder in your project working directory as `wpa_7_LastFirst.R`, where Last and First are your last and first names. 

2. The data are stored in a tab--delimited text file located at https://raw.githubusercontent.com/ndphillips/IntroductionR_Course/master/assignments/wpa/data/facebook.txt. Using `read.table()` load this data into R as a new object called `facebook`

## Understand the data

3. Look at the first few rows of the dataframe with the `head()` and `View()` functions to make sure it loaded correctly. 

```{r, eval = FALSE, echo = FALSE}
head(facebook)
```

4. Using the `names()` and `str()` functions, look at the names and structure of the dataframe to make sure everything looks ok. If the data look strange, you did something wrong with `read.table()` diagnose the problem!

```{r, eval = FALSE, echo = FALSE}
str(facebook)
```

5. Using `write.table()`, save a local copy of the facebook data to a text file called `facebook.txt` in the data folder of your project. Now, you'll always have access to the data.

## Answer guidelines Read carefully to save yourself time!

- For each question, conduct the appropriate ANOVA by creating an object called `tX_aov`, where X is the task number. Look at the results using `summary()`. Then, write the conclusion in APA style. To summarize an effect in an ANOVA, use the format F(XXX, YYY) = FFF, p = PPP, where XXX is the degrees of freedom of the variable you are testing, YYY is the degrees of freedom of the residuals, FFF is the F value for the variable you are testing, and PPP is the p-value (if the p-value is less than .01, just write p < .01).

- If the p-value of the ANOVA is less than .05, conduct post-hoc tests. If you are only testing one independent variable, write APA conclusions for the post-hoc test. If you are testing more than one independent variable in your ANOVA, you do not need to write APA style conclusions for post-hoc tests.

For example, here is how I would analyze and answer the question: "Was there an effect of diets on Chicken Weights?""

```{r, eval = TRUE, echo = TRUE}
# ANOVA on Chicken Weights
#   IV = Diet, DV = weight

# ANOVA
t0_aov <- aov(formula = weight ~ Diet,
              data = ChickWeight)

# Look at summary results
summary(t0_aov)

# ANOVA was significant (p < .01), so I'll conduct post-hoc tests

# Tukey post-hoc tests
TukeyHSD(t0_aov)

# Conclusion
#  There was a significant main effect of diets on chicken weights (F(3, 574) = 10.81, p < .01). Pairwise Tukey HSD tests showed significant differences between diets 1 and 3 (diff = 40.30, p < .01) and diets 1 and 4 (diff = 32.62, p < .01). All other pairwise differences were not significant at the 0.05 significance threshold.
```

## One-way ANOVAS

6. Was there a main effect of the university on dateability? Conduct a one-way ANOVA. If the result is significant (p < .05), conduct post-hoc tests. <font color="red">Report full APA style conclusions</font>

```{r, eval = FALSE, echo = FALSE}
t6_aov <- aov(formula = dateability ~ university,
            data = facebook)

summary(t6_aov)

TukeyHSD(t6_aov)

#Answer: There was a significant main effect of university on dateability (F(2, 997) = 13.99, p < .01). Pairwise Tukey HSD tests showed significant differences between Zurich and Basel (diff = -10.27, p < .01) and Geneva and Basel (diff = -8.64, p < .01). All other pairwise differences were not significant at the 0.05 significance threshold.*
```



7. Was there a main effect of intelligence on dateability? Conduct a one-way ANOVA. If the result is significant (p < .05), conduct post-hoc tests. <font color="red">Report full APA style conclusions</font>

```{r, eval = FALSE, echo = FALSE}
t7_aov <- aov(formula = dateability ~ intelligence,
              data = facebook)

summary(t7_aov)

TukeyHSD(t7_aov)

# *Answer: There was a significant main effect of intelligence on dateability (F(2, 997) = 4.97, p < .01). Pairwise Tukey HSD tests showed significant differences between Medium and Low intelligence (diff = 6.53, p < .01). All other pairwise differences were not significant at the 0.05 significance threshold.*
```



8. Was there a main effect of haircolor on dateability? Conduct a one-way ANOVA. If the result is significant (p < .05), conduct post-hoc tests. <font color="red">Report full APA style conclusions</font>

```{r, eval = FALSE, echo = FALSE}
t8_aov <- aov(formula = dateability ~ haircolor,
              data = facebook)

summary(t8_aov)

# *Answer: There was no significant main effect of haircolor on dateability (F(2, 997) = 1.23, p = 0.29).*
```


## Multi way, independent ANOVAs

9. Conduct a three-way ANOVA on dateability with both intelligence, university and haircolor as IVs. Do your results for each variable change compared to your previous one-way ANOVAs on these variables? (You do not need to give APA results or conduct post-hoc tests, just answer the question verbally).

```{r, eval = FALSE, echo = FALSE}
t9_aov <- aov(formula = dateability ~ intelligence + university + haircolor,
              data = facebook)

summary(t9_aov)

# *Answer: Yes the results are the same!*
```


10. Conduct a multi-way anova including sex, haircolor, university, education, shirtless, intelligence and attractiveness as independent variables predicting dateability. Which variables are significantly related to dateability? <font color="red">*Do* write APA results for each variable but do *not* conduct post-hoc tests</font>.

```{r, eval = FALSE, echo = FALSE}
t10_aov <- aov(formula = dateability ~ sex + haircolor + university + education + shirtless + intelligence + attractiveness,
               data = facebook)

summary(t10_aov)

# *Answer: There were significant effects of sex (F(1, 986) = 66.10, p < .01), university (F(2, 986) = 17.35, p < .01), intelligence (F(2, 986) = 5.34, p < .01) and attractiveness (F(2, 986) = 101.87, p < .01).*
```



## Interactions

11. Create a plot (e.g.; `pirateplot()`, `barplot()`, `boxplot()`) showing the distribution of dateability based on two independent variables: sex and shirtless. Based on what you see in the plot, do you expect there to be an interaction between sex and shirtless? Why or why not?

```{r, echo = FALSE, eval = FALSE}
library(yarrr)
pirateplot(dateability ~ sex + shirtless, 
           data = facebook)

# Yes there looks like an intereaction!
```


12.  Test your prediction with the appropriate ANOVA. <font color="red">Report full APA style conclusions</font>
```{r, echo = FALSE, eval = FALSE}
t12_aov <- aov(dateability ~ sex * shirtless, 
               data = facebook)
            
summary(t12_aov)

# Yep I was right!
```


## ANOVAs on subsets of data

13. It turns out that the experimenter who ran sessions 1 through 30 (a man) was trying to score a date and slipped in his own profile picture into the study. We can't trust these data. Repeat your multi anova from question 9 ONLY for sessions larger than 30 (Hint: Make the changes to the `data` argument). Do your conclusions change compared to when you analyzed the data from all sessions?

```{r, eval = FALSE, echo = FALSE}
t13_aov <- aov(formula = dateability ~ sex + haircolor + university + education + shirtless + intelligence + attractiveness,
               data = subset(facebook, session > 30))

summary(t13_aov)

# The results look the same
```


# CHECKPOINT!

```{r, eval = TRUE, echo = FALSE, out.width = "20%"}
knitr::include_graphics("https://www.mariowiki.com/images/thumb/6/65/CheckpointSM3DL.png/115px-CheckpointSM3DL.png")
```


### More interactions

14. Create a plot (e.g.; using `ggplot` or the `yarrr::pirateplot()` function shown in the examples above) showing the distribution of dateability based on two independent variables: university and education. Based on what you see in the plot, do you expect there to be an interaction between university and education? Why or why not?

```{r}
pirateplot(dateability ~ shirtless + sex, 
           data = facebook)

# Yes there looks like an interaction!
```

15. Test your prediction with the appropriate ANOVA. <font color="red">Report full APA style conclusions</font>

```{r}
t15_aov <- aov(dateability ~ shirtless * sex, 
               data = facebook)

summary(t15_aov)

# I was right again!
```
    
    
16. Create a plot showing the distribution of dateability based on two independent variables: university and haircolor. Based on what you see in the plot, do you expect there to be an interaction between university and intelligence? Why or why not?

```{r, eval = FALSE, echo = FALSE}
pirateplot(dateability ~ university + haircolor, 
           data = facebook)

# There does not look like an interaction
```

17. Test your prediction with the appropriate ANOVA. <font color="red">Report full APA style conclusions</font>

```{r}
t17_aov <- aov(dateability ~ university * haircolor, 
               data = facebook)

summary(t17_aov)

# Yep! no significant interaction!
```


18. Repeat the test from the previous question, but **only** include males over the age of 25. Do you get the same answer?.

### Learn more

19. You can print an `aov` object to visualize things like the model residuals. Try plotting the results of your anova from question 17 (e.g.; `plot(t17_aov)`) and look at the resulting plots. 

20. You can use the `apa_print()` function from the `papaja` package to print apa style conclusions from `aov` objects. The `papaja` package is on GitHub (not on CRAN), so to install it you'll need to use the `install_github()` function from the `devtools` package as follows:

```{r, eval = FALSE, echo = TRUE}
install.packages("devtools")            # Only if you don't have the devtools package
devtools::install_github("crsh/papaja") # Install the papaja package from GitHub
library("papaja")                       # Load the papaja package
```

Now that you've got it, try evaluating `apa_print()` on some of your previous `aov` objects to see what happens. You may notice that the results have special characters like `$` and `\\`. This is because the output contains formatting code for LaTeX.

21. You can use the `predict()` function to use a model (like an ANOVA) to predict the values of new data using the notation `predict(MODEL, newdata)`. Using your ANOVA from question 8, predict the dateability of the following 5 students:

```{r, echo = TRUE}
newdata <- data.frame("id" = c(1, 2, 3, 4, 5),
                      "haircolor" = c("brown", "brown", "blonde", "blonde", "brown"),
                      "university" = c("1.Basel", "1.Basel", "2.Zurich", "3.Geneva", "3.Geneva"),
                      stringsAsFactors = FALSE)
```

22. There are different "types" of ANOVAS. The `aov()` function in R calculates what is known as a type I ANOVA. If your data are severely imbalanced, that is, where the number of observations in each group are not similar, then using a Type I ANOVA can lead to misleading results. In this case, it's better to use a Type II or Type III ANOVA. The `Anova()` function from the `car` package allows you to conduct these types of ANOVAs. Here's how to use the `Anova()` function:

```{r, echo = TRUE}
install.packages("car")  # Only if you don't have the car package yet
library("car")           # Load the car package

# Is there a relationship between sex and college on tattoos?

# First, create an lm() object, the Anova() function needs this:

model_lm <- lm(formula = tattoos ~ sex + college, 
         data = pirates)

# Type II anova

Anova(model_lm, 
      type = "II")   # Type II

# Type III anova

Anova(model_lm, 
      type = "III")  # Type III

# Type I anova using the aov() function

summary(aov(model_lm))

# In this case, all three tests give virtually the same answers (thankfully)
```

Now, answer the question: "Is there an interaction between shirtless and sex on dating desireability?" by conducting three separate ANOVAS, one that is Type I (using `aov()`), one that is Type II (using `Anova()`), and one that is Type III (using `Anova()`). Do you get the same or different answers? To learn more about how the different ANOVA types work, look at this post by Falk Scholer: [http://goanna.cs.rmit.edu.au/~fscholer/anova.php](http://goanna.cs.rmit.edu.au/~fscholer/anova.php).

23. Does it affect an ANOVA to standardize the dependent variable? Test this by conducting an ANOVA testing the effect of attractiveness on dateability. Do this once using the raw dateability scores, and once again after standardizing the dateability scores (Hint: To standardize a variable, subtract its mean then divide by its standard deviation). Do you get the same or different results?

## Submit!

- Save and email your `wpa_7_LastFirst.R` file to me at nathaniel.phillips@unibas.ch.
- Go to [https://goo.gl/forms/b9dcRH6Ud3pDagOr1](https://goo.gl/forms/b9dcRH6Ud3pDagOr1) to confirm your assignment submission.

